name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - '**/*.py'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.toml'
      - '.github/workflows/ci-sast-secrets.yml'
      - 'security/**'
  pull_request:
    paths:
      - '**/*.py'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.toml'
      - '.github/workflows/ci-sast-secrets.yml'
      - 'security/**'

permissions:
  contents: read
  security-events: write

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P10

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Run Semgrep SAST
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            -w /src \
            returntocorp/semgrep:latest \
            semgrep ci \
              --config p/ci \
              --config security/semgrep/rules.yml \
              --sarif \
              --output EVIDENCE/P10/semgrep.sarif \
              --metrics=off \
              --disable-version-check || echo "{}" > EVIDENCE/P10/semgrep.sarif

      - name: Verify Semgrep SARIF
        run: |
          if [ -f EVIDENCE/P10/semgrep.sarif ] && [ -s EVIDENCE/P10/semgrep.sarif ]; then
            echo "SARIF file generated successfully"
            echo "File size: $(wc -c < EVIDENCE/P10/semgrep.sarif) bytes"
          else
            echo "Warning: SARIF file is empty or missing"
          fi

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: EVIDENCE/P10/semgrep.sarif
          category: semgrep
        continue-on-error: true

      - name: Run Gitleaks secrets scanning
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/repo \
            -w /repo \
            zricethezav/gitleaks:latest \
            detect \
              --no-banner \
              --config=/repo/security/.gitleaks.toml \
              --source=/repo \
              --report-format=json \
              --report-path=/repo/EVIDENCE/P10/gitleaks.json \
              --verbose || echo "[]" > EVIDENCE/P10/gitleaks.json

      - name: Verify Gitleaks report
        run: |
          if [ -f EVIDENCE/P10/gitleaks.json ] && [ -s EVIDENCE/P10/gitleaks.json ]; then
            echo "Gitleaks report generated successfully"
            echo "File size: $(wc -c < EVIDENCE/P10/gitleaks.json) bytes"
            # Count findings
            if command -v jq &> /dev/null; then
              COUNT=$(jq 'length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo "0")
              echo "Findings count: $COUNT"
            fi
          else
            echo "Warning: Gitleaks report is empty or missing"
          fi

      - name: Generate SAST Summary
        run: |
          echo "# SAST & Secrets Scanning Summary" > EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "Generated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> EVIDENCE/P10/sast_summary.md
          echo "Commit: ${{ github.sha }}" >> EVIDENCE/P10/sast_summary.md
          echo "Workflow run: ${{ github.run_id }}" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md

          echo "## Semgrep SAST Results" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          if [ -f EVIDENCE/P10/semgrep.sarif ] && [ -s EVIDENCE/P10/semgrep.sarif ]; then
            if command -v jq &> /dev/null; then
              # Count findings by severity
              ERROR_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
              WARNING_COUNT=$(jq '[.runs[].results[] | select(.level == "warning")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
              INFO_COUNT=$(jq '[.runs[].results[] | select(.level == "info")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")

              echo "| Severity | Count |" >> EVIDENCE/P10/sast_summary.md
              echo "|----------|-------|" >> EVIDENCE/P10/sast_summary.md
              echo "| Error | $ERROR_COUNT |" >> EVIDENCE/P10/sast_summary.md
              echo "| Warning | $WARNING_COUNT |" >> EVIDENCE/P10/sast_summary.md
              echo "| Info | $INFO_COUNT |" >> EVIDENCE/P10/sast_summary.md
              echo "" >> EVIDENCE/P10/sast_summary.md

              TOTAL=$((ERROR_COUNT + WARNING_COUNT + INFO_COUNT))
              echo "**Total Semgrep findings: $TOTAL**" >> EVIDENCE/P10/sast_summary.md
              echo "" >> EVIDENCE/P10/sast_summary.md

              if [ "$TOTAL" -gt 0 ]; then
                echo "### Key Findings" >> EVIDENCE/P10/sast_summary.md
                echo "" >> EVIDENCE/P10/sast_summary.md
                jq -r '.runs[].results[] | select(.level == "error" or .level == "warning") | "- **\(.ruleId)**: \(.message.text) (in \(.locations[0].physicalLocation.artifactLocation.uri))"' EVIDENCE/P10/semgrep.sarif 2>/dev/null | head -10 >> EVIDENCE/P10/sast_summary.md || true
                echo "" >> EVIDENCE/P10/sast_summary.md
              fi
            else
              echo "jq not available, skipping detailed analysis" >> EVIDENCE/P10/sast_summary.md
            fi
          else
            echo "Semgrep SARIF report not generated or is empty." >> EVIDENCE/P10/sast_summary.md
          fi

          echo "## Gitleaks Secrets Scanning Results" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          if [ -f EVIDENCE/P10/gitleaks.json ] && [ -s EVIDENCE/P10/gitleaks.json ]; then
            if command -v jq &> /dev/null; then
              COUNT=$(jq 'length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo "0")
              echo "**Total secrets detected: $COUNT**" >> EVIDENCE/P10/sast_summary.md
              echo "" >> EVIDENCE/P10/sast_summary.md

              if [ "$COUNT" -gt 0 ]; then
                echo "### Detected Secrets" >> EVIDENCE/P10/sast_summary.md
                echo "" >> EVIDENCE/P10/sast_summary.md
                jq -r '.[] | "- **\(.RuleID)**: \(.Description) (in \(.File))"' EVIDENCE/P10/gitleaks.json 2>/dev/null | head -10 >> EVIDENCE/P10/sast_summary.md || true
                echo "" >> EVIDENCE/P10/sast_summary.md
                echo "⚠️ **Action required**: Review detected secrets and either:" >> EVIDENCE/P10/sast_summary.md
                echo "1. Remove them from code and use environment variables" >> EVIDENCE/P10/sast_summary.md
                echo "2. Add them to allowlist in \`security/.gitleaks.toml\` if they are false positives" >> EVIDENCE/P10/sast_summary.md
              else
                echo "✅ No secrets detected." >> EVIDENCE/P10/sast_summary.md
              fi
            else
              echo "jq not available, skipping detailed analysis" >> EVIDENCE/P10/sast_summary.md
            fi
          else
            echo "Gitleaks report not generated or is empty." >> EVIDENCE/P10/sast_summary.md
          fi

          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "## Next Steps" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "1. Review Semgrep findings and fix critical issues" >> EVIDENCE/P10/sast_summary.md
          echo "2. Verify any detected secrets and remove them if real" >> EVIDENCE/P10/sast_summary.md
          echo "3. Update allowlists if findings are false positives" >> EVIDENCE/P10/sast_summary.md
          echo "4. Full reports available in:" >> EVIDENCE/P10/sast_summary.md
          echo "   - \`EVIDENCE/P10/semgrep.sarif\`" >> EVIDENCE/P10/sast_summary.md
          echo "   - \`EVIDENCE/P10/gitleaks.json\`" >> EVIDENCE/P10/sast_summary.md

      - name: Upload Semgrep SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: EVIDENCE/P10/semgrep.sarif
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Gitleaks report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: EVIDENCE/P10/gitleaks.json
          retention-days: 30
          if-no-files-found: warn

      - name: Upload SAST summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-summary
          path: EVIDENCE/P10/sast_summary.md
          retention-days: 30
          if-no-files-found: warn

      - name: Upload all evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-p10
          path: EVIDENCE/P10/
          retention-days: 30
          if-no-files-found: warn
