# Отчет по безопасности проекта

## Общая информация

Данный отчет демонстрирует выполнение требований к моделированию угроз и нефункциональным требованиям безопасности.

Все данные в отчете взяты из существующих документов проекта:
- `docs/security-nfr/NFR.md` — нефункциональные требования
- `docs/threat-model/DFD.md` — диаграммы потоков данных
- `docs/threat-model/STRIDE.md` — анализ угроз STRIDE
- `docs/threat-model/RISKS.md` — реестр рисков
- `docs/security-nfr/NFR_TRACEABILITY.md` — матрица трассировки
- `docs/adr/` — архитектурные решения

---

## 1. Нефункциональные требования (NFR) ≥8 с критериями (источник: docs/security-nfr/NFR.md)

В проекте определено **10 нефункциональных требований безопасности и производительности**, каждое из которых содержит четкие критерии и метрики.

| ID | Название | Критерий/Метрика | Приоритет |
|----|----------|------------------|-----------|
| **NFR-01** | Безопасное хранение паролей | Argon2id, t=3, m=256MB, p=1 | High |
| **NFR-02** | Формат ошибок RFC7807 | 100% endpoint'ов | Medium |
| **NFR-03** | Время ответа API | p95 ≤ 250 мс | High |
| **NFR-04** | Устойчивость к нагрузке | p99 ≤ 400 мс; err ≤ 1% | Medium |
| **NFR-05** | Уязвимости зависимостей | ≤ 7 дней | High |
| **NFR-06** | Аудит логов | 100% POST/PUT/DELETE | Medium |
| **NFR-07** | Ограничение частоты запросов | 10 RPS / IP; 100 RPS / user | Medium |
| **NFR-08** | Ротация токенов JWT | TTL ≤ 30 дней | Medium |
| **NFR-09** | Доступность сервиса (SLA) | ≥ 99.5% | High |
| **NFR-10** | Защита от конфликтов данных | 100% корректность голосов | Medium |

---

## 2. Диаграммы потоков данных (DFD) 3-4 с границами доверия (источник: docs/threat-model/DFD.md)

В проекте определена **основная DFD с 4 границами доверия**:

### Границы доверия :
1. **Trust Boundary: Клиент** — User Browser / App
2. **Trust Boundary: Public API** — FastAPI Service, Rate Limiter
3. **Trust Boundary: Core Systems** — PostgreSQL, Auth Module, Centralized Logs
4. **Trust Boundary: Infrastructure** — CI/CD, Monitoring

### Потоки данных (9 потоков):
- **F1**: POST /auth/register → регистрация пользователя
- **F2**: Argon2id hash → хэширование пароля
- **F3**: SQL INSERT user → запись пользователя в БД
- **F4**: GET /features → получение списка функций
- **F5**: SQL SELECT /features → чтение данных из БД
- **F6**: POST /vote → голосование за функцию
- **F7**: Emit log → логирование действий
- **F8**: Dependency scan → сканирование зависимостей в CI
- **F9**: Collect metrics → сбор метрик мониторинга

---

## 3. STRIDE-анализ ≥8 угроз (источник: docs/threat-model/STRIDE.md)

Выявлено **9 угроз** по методологии STRIDE, покрывающих все категории:

| ID | Поток | STRIDE | Угроза | Контроль (мера) | Связанный NFR |
|----|-------|--------|--------|-----------------|---------------|
| **F1** | POST /auth/register | **S**poofing | Подделка личности при регистрации | HTTPS, проверка email, JWT | NFR-08 |
| **F2** | Argon2id hashing | **T**ampering | Изменение пароля или хэша | Использование Argon2id с солью | NFR-01 |
| **F3** | SQL INSERT user | **R**epudiation | Отказ от факта регистрации | Логирование с user_id и IP | NFR-06 |
| **F4** | GET /features | **I**nformation Disclosure | Утечка ошибок с PII | Формат RFC7807 без stacktrace | NFR-02 |
| **F5** | SQL SELECT /features | **E**levation of Privilege | Доступ к чужим голосам и данным пользователей | RBAC на уровне ORM | NFR-10 |
| **F6** | POST /vote | **D**enial of Service | Перегрузка API голосами | Rate limit: 10 RPS/IP, 100 RPS/user | NFR-07 |
| **F7** | Logs / audit trail | **R**epudiation | Отказ от действий пользователя | Подпись логов, централизованное хранилище | NFR-06 |
| **F8** | CI: Dependabot / Snyk | **T**ampering | Вредоносные зависимости | CI: Dependabot + Snyk, исправление CVE ≤ 7 дней | NFR-05 |
| **F9** | Monitoring / Metrics | **I**nformation Disclosure | Утечка внутренних метрик | Доступ по VPN/токену, авторизация | NFR-09 |

---

## 4. Меры защиты с трассировкой к угрозам и историям

Все меры защиты имеют четкую трассировку к угрозам STRIDE, рискам из Risk Register и историям из Traceability Matrix.

### Матрица трассировки мер защиты:

| Мера защиты | Трассировка к угрозам | Трассировка к NFR | Трассировка к историям/ADR |
|-------------|----------------------|-------------------|----------------------------|
| **HTTPS, JWT аутентификация** | F1 (Spoofing) → R1 | NFR-08 | AUTH-07 (NFR_TRACEABILITY.md), ADR-001 |
| **Argon2id хэширование паролей** | F2 (Tampering) → R2 | NFR-01 | AUTH-01 (NFR_TRACEABILITY.md) |
| **RFC 7807 формат ошибок** | F4 (Information Disclosure) → R4 | NFR-02 | API-03 (NFR_TRACEABILITY.md), ADR-001 |
| **Rate limiting (10 RPS/IP)** | F6 (DoS) → R6, R10 | NFR-07 | API-05 (NFR_TRACEABILITY.md), ADR-002 |
| **Логирование операций** | F3, F7 (Repudiation) → R3 | NFR-06 | LOG-01 (NFR_TRACEABILITY.md) |
| **RBAC на уровне ORM** | F5 (Elevation) | NFR-10 | VOTE-02 (NFR_TRACEABILITY.md) |
| **Dependabot + Snyk в CI** | F8 (Tampering) → R7 | NFR-05 | SEC-02 (NFR_TRACEABILITY.md) |
| **Защита метрик (VPN/токен)** | F9 (Information Disclosure) → R8 | NFR-09 | OPS-01 (NFR_TRACEABILITY.md) |
| **Валидация входных данных** | - → R5 | NFR-02, NFR-09 | API-03 (NFR_TRACEABILITY.md), ADR-003 |
| **Нагрузочное тестирование** | - → R10 | NFR-03, NFR-04 | PERF-01, PERF-02 (NFR_TRACEABILITY.md) |

### Детальная трассировка на примере Rate Limiting:

**Мера:** Rate limiting middleware (10 RPS на IP)

**Трассировка к угрозам:**
- F6 (DoS через перегрузку API голосами)
- R6 (DoS /vote)
- R10 (Перегрузка API)

**Трассировка к NFR:**
- NFR-07 (Ограничение частоты запросов)

**Трассировка к историям:**
- API-05: Реализовать rate limiting (docs/security-nfr/NFR_TRACEABILITY.md)
- ADR-002: Rate Limiting (docs/adr/ADR-002-rate-limiting.md)

**Реализация:**
- Файл: `app/main.py` (строки 15-61)
- Тесты: `tests/test_rate_limit.py`
- Формат ошибок: RFC 7807 с HTTP 429

### Трассировка через ADR:

Все архитектурные решения документированы в ADR с трассировкой:
- **ADR-001**: RFC7807 ошибки → R4, NFR-07, NFR-09, STRIDE Information Disclosure
- **ADR-002**: Rate Limiting → R6, R10, NFR-07, STRIDE DoS
- **ADR-003**: Input Validation → NFR-02, NFR-09, STRIDE Tampering

---

## 5. Приоритизация и оформление

### Приоритизация рисков

Риски проанализированы с использованием матрицы рисков. (источник: docs/threat-model/RISKS.md)

| ID | Риск | L | I | Risk Score | Стратегия | Приоритет |
|----|------|---|---|------------|-----------|-----------|
| R1 | Подделка JWT токенов | 3 | 5 | **15** | Снизить | Высокий |
| R6 | DoS /vote | 4 | 4 | **16** | Снизить | Высокий |
| R7 | Уязвимые пакеты | 3 | 5 | **15** | Снизить | Высокий |
| R10 | Перегрузка API | 4 | 4 | **16** | Снизить | Высокий |
| R3 | Нет логирования | 3 | 4 | **12** | Снизить | Средний |
| R9 | SLA <99.5% | 3 | 4 | **12** | Снизить | Средний |
| R2 | Пароли не хэшируются | 2 | 5 | **10** | Избежать | Средний |
| R5 | SQL-инъекция | 2 | 5 | **10** | Избежать | Средний |
| R4 | Утечка ошибок API | 3 | 3 | **9** | Снизить | Низкий |
| R8 | Метрики публичны | 2 | 4 | **8** | Принять | Низкий |

### Приоритизация NFR

| Приоритет | NFR ID | Источник данных |
|-----------|--------|-----------------|
| **High** | NFR-01, NFR-03, NFR-05, NFR-09 | docs/security-nfr/NFR.md |
| **Medium** | NFR-02, NFR-04, NFR-06, NFR-07, NFR-08, NFR-10 | docs/security-nfr/NFR.md |
