---
Status: Accepted
Date: 2025-10-20
---

## Context
API ошибки возвращались в произвольном формате `{"error": {"code": "...", "message": "..."}}`, что затрудняло:
- Корреляцию инцидентов между логами и клиентскими запросами
- Стандартизированную обработку ошибок клиентами
- Маскирование чувствительных деталей (риск R4 в `docs/threat-model/RISKS.md`)

Требования NFR-07 (observability) и NFR-09 (error hygiene) не выполнялись.

## Decision
Внедрить стандарт RFC 7807 (application/problem+json) с обязательным `correlation_id`:
- Единый формат: `type`, `title`, `status`, `detail`, `correlation_id`
- Middleware для генерации/передачи correlation_id
- Карта типов ошибок без чувствительных деталей
- Content-Type: `application/problem+json`

## Alternatives
1. **Оставить текущий формат** - отклонено: не решает проблему корреляции
2. **Использовать только correlation_id без RFC 7807** - отклонено: не стандартизирует формат
3. **Создать собственный формат ошибок** - отклонено: изобретение велосипеда

## Consequences
**Положительные:**
- Улучшена наблюдаемость и трассировка инцидентов
- Стандартизированная обработка ошибок клиентами
- Соответствие RFC 7807 для лучшей совместимости

**Отрицательные:**
- Требуется обновление всех тестов
- Клиенты должны обновить обработку ошибок
- Дополнительный overhead на генерацию correlation_id

## Security Impact
- **Снижение риска R4**: маскирование чувствительных деталей в ошибках
- **Улучшение аудита**: correlation_id позволяет связать логи с запросами
- **Стандартизация**: единообразная обработка ошибок снижает риск утечек

## Rollout Plan
1. **Фаза 1**: Реализация middleware и обработчиков ошибок
2. **Фаза 2**: Обновление всех тестов для проверки RFC 7807 формата
3. **Фаза 3**: Документирование нового формата для клиентов
4. **Фаза 4**: Мониторинг корреляции инцидентов

## Links
- NFR: NFR-07 (Rate limit/observability), NFR-09 (Error hygiene)
- Threat Model: STRIDE Information Disclosure; Risk: R4 закрывается тестом
- Code: `app/main.py` (middleware + handlers)
- Tests: `tests/test_errors.py`, `tests/test_rate_limit.py`, `tests/test_features.py`
