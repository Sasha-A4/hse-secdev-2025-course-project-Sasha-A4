---
Status: Accepted
Date: 2025-10-20
---

## Context
Эндпоинты `/features` и `/vote` уязвимы к DoS-атакам через:
- Массовые запросы на создание/голосование за фичи
- Перегрузка сервера при высокой нагрузке
- Отсутствие защиты от злоупотреблений

Риски R6 (DoS /vote) и R10 (Перегрузка API) в `docs/threat-model/RISKS.md` требуют решения.
NFR-07 требует ограничения нагрузки и предсказуемых ответов.

## Decision
Внедрить per-IP rate limiting в middleware:
- Лимит: 10 запросов в секунду на IP
- Окно: 1 секунда (sliding window)
- При превышении: HTTP 429 с RFC 7807 + `Retry-After: 1`
- Исключение: `/health` не ограничивается

## Alternatives
1. **Token bucket алгоритм** - отклонено: избыточно для простого случая
2. **Distributed rate limiting** - отклонено: нет Redis/внешнего хранилища
3. **Per-user rate limiting** - отклонено: нет аутентификации
4. **Без rate limiting** - отклонено: не решает риски R6/R10

## Consequences
**Положительные:**
- Защита от DoS и злоупотреблений
- Предсказуемое поведение при перегрузке
- Соответствие NFR-07

**Отрицательные:**
- Возможны ложноположительные срабатывания для легитимных пользователей
- Простой per-IP подход не учитывает разные типы пользователей
- Нет персистентности при перезапуске сервера

## Security Impact
- **Снижение риска R6**: защита эндпоинта `/vote` от злоупотреблений
- **Снижение риска R10**: предотвращение перегрузки API
- **DoS защита**: ограничение частоты запросов с одного IP
- **Graceful degradation**: 429 вместо 500 при перегрузке

## Rollout Plan
1. **Фаза 1**: Реализация middleware с deque-based sliding window
2. **Фаза 2**: Интеграция с RFC 7807 error responses
3. **Фаза 3**: Тестирование лимитов и мониторинг метрик
4. **Фаза 4**: Настройка алертов на превышение лимитов

## Links
- NFR: NFR-07 (Rate limiting)
- Threat Model: STRIDE DoS; Risks: R6, R10
- Code: `app/main.py` (deque window, 429 problem)
- Tests: `tests/test_rate_limit.py`
